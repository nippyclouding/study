Servlet의 이해

스프링 부트는 Tomcat WAS 서버를 내장하고 있어 편리하게 서블릿을 이용할 수 있다.
서블릿 객체는 싱글톤으로, HTTP reqeust, response 객체는 클라이언트 요청마다 생성한다. 
=> HTTP 요청을 어떻게 받고, HTTP 응답을 어떻게 전송할 지에 대한 이해가 중요하다.
흐름 : HTTP 요청 시 WAS가 request, response 객체를 생성 후 서블릿 컨테이너에 전달한다.

톰캣은 서블릿을 감싸는 컨테이너 기능, 서블릿 컨테이너라고도 한다.
------------------------------------------------------------------------------
<서블릿>

서블릿 : 요청, 응답을 처리하기 위한 자바 클래스 (객체) 

HttpServlet을 extends하는 클래스는 서블릿 객체가 된다.
class ServletTest extends HttpServlet { ... }

extends HttpServlet 시 init(), doGet(), doPost(), destroy() 등 HttpServlet 기능을 오버라이딩 할 수 있다.
doGet : get 요청 시 응답 수행
doPost : post 요청 시 응답 수행

오버라이딩 시 HttpServletRequest, HttpServletResponse 객체를 파라미터로 가지는데, 이 객체들은 요청, 응답 시 여러 편의 메서드를 가진다. 
request.getParameter(..)
response.set...

서블릿 포워드 : 요청을 다른 리소스로 전달
서블릿 포워드 방식 : 하나의 요청
- 클라이언트의 요청 -> 요청을 받은 서블릿이 다른 서블릿으로 요청을 보낸다.
  다른 서블릿이 요청을 처리하고 클라이언트에게 다시 리턴한다. 
  ex :
  @GetMapping("/")
  public String index() {
      return "index";  // 실제로는 /WEB-INF/views/index.jsp로 포워드
  }
  => getMapping 요청 시 return "index" : index.jsp 등을 리턴 => 현재 요청받은 서블릿이 다른 서블릿으로 요청을 보낸다. (jsp가 처리, jsp도 서블릿의 일종이다.)

Redirect 방식 : 두 번의 요청
- 클라이언트의 요청 -> 요청을 받은 서블릿이 리다이렉트 신호를 클라이언트에 전달 
- 클라이언트는 리다이렉트 신호를 전달받고 새로운 주소로 요청
- 새로운 주소의 서블릿이 해당 요청을 처리, 응답

서블릿 실습
@WebServlet("/first")
public class FirstServlet extends HttpServlet {
	protected void doGet(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
		res.setContentType("text/html;charset=utf-8");
		res.sendRedirect("second");
	}
}

@WebServlet("/second")
public class SecondServlet extends HttpServlet {
	protected void doGet(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
		res.setContentType("text/html;charset=utf-8");
		PrintWriter out = res.getWriter();
		out.println("<html><body>");
		out.println("sendRedirect를 이용한 실습");
		out.println("</body></html>");
	}
}

first에 요청 시 FirstServlet이 호출을 받은 뒤 클라이언트에 리다이렉트 응답 리턴
클라이언트는 리다이렉트 응답을 받고 second에 요청, SecondServlet이 요청 처리

개발자 도구 확인
first	 302	document / Redirect	Other	0.2 kB	5 ms
second 200	document	first	0.2 kB	3 ms


HttpServletResponse의 sendRedirect() 메서드를 이용한다.

그 외 : html (refresh), javascript의 location 등 브라우저에서 일어나는 방식이 있다.


------------------------------------------------------------------------------

서버 사이드 렌더링 SSR : 서버가 내려주는 뷰 (JSP, 타임리프 ..)
클라이언트 사이드 렌더링 CRS : 클라이언트가 내려주는 뷰, (React, Vue.js ..)

<HTTP SERVLET REQUEST>
- HtpServletRequest : Http 요청이 왔을 때 해당 요청을 개발자가 편리하게 조회할 수 있도록 파싱하는 역할 (Http 헤더 정보, 바디 정보 ..)
- WAS가 Request 객체를 지원하고 Servlet이 해당 객체를 사용하여 편의 기능을 제공
- 흐름 : 사용자의 Http 요청 -> 클라이언트 to 서버로 Http 요청 전달 -> 서버의 로직 수행 -> 서버 to 클라이언트로 결과 전달

Http 요청을 client -> server로 전달하는 방법
1. GET 방식으로 쿼리 파라미터 사용
2. POST 방식으로 HTML Form 사용
3. POST 방식으로 Http Message Body에 데이터를 직접 담아 요청 (Rest Api)

1. GET 방식의 쿼리 파라미터 사용
http://loccalhost:8080/request-param?username=hello&age=20
=> URL에 username과  age에 대한 정보를 설정하여 서버로 보낼 수 있다.
=> GET 방식으로 서버에 데이터를 전달 시 HTTP의 헤더를 통해 데이터를 전달한다.(HTTP BODY는 비어있다.)

서버에서 Get 방식 요청 조회 : HttpServletRequest가 제공하는 편의 메서드로 가능
- request.getParameter("username") : 단일 파라미터 조회
- request.getParameterNames() : 파라미터 이름들을 모두 조회
- request.getParameterMap() : 파라미터를 Map으로 조회
- request.getParameterValues("username") : username 필드 안에 들어있는 여러 개의(복수) 파라미터들을 조회


2. POST 방식의 HTML Form 사용
<form action="/save" method = "post">
  <input type = "text" name = "username"/>
  <input type = "text" name = "age"/>
  <button type = "submit">전송</button>
</form>

=> Http method를 post로 설정하여 /save 서버 경로로 username, age 데이터를 전달할 수 있다.
=> Post 방식으로 Form을 통해 데이터를 서버로 전달하는 방법도 Get 방식과 마찬가지로 request.getParameter()을 통해 서버에서 조회가 가능하다.
=> Post 방식으로 Form을 통해 서버에 데이터 전달 시 HTTP BODY를 통해 데이터를 보내기 때문에 content-type을 지정해야 한다.
(application/x-www-form-urlencoded)




3. Post 방식으로 Http Message Body 사용

HTTP 헤더가 아닌 바디에 데이터를 직접 담아 전달
- Http 요청 시 content-type : application/json으로 설정 (Postman 기준)
- Http 요청 경로 : POST http://localhost:8080/request-body-json = request-body-json 서버 경로에 데이터 전달
- message body : {"username" : "hello", "age" : 20} 입력
=> 서버에 json을 이용하여 username = hello, age = 20 이라는 데이터를 전달한다.

- 서버에서의 Http 요청 조회
@WebServlet(name = "test", urlPatterns = "/request-body-json)
public class JsonEx extends HttpServlet{

  private ObjectMapper objectMapper = new ObjectMapper();

  @Override
  protected void service(HttpServletRequest request, HttpServletResponse response) 
                                                  throws ServletException, IOException{

    //request 요청을 String 타입으로 변환
    //readValue로 변환한 String 내용을 Java 객체에 담아서 서버에서 조회한다.

    ServletInputStream inputStream = request.getInputStream();
    String messageBody = StreamUtils.copyToString(inputStream, StandardCharsets.UTF_8);

    JsonObject jsonObject = objectMapper.readValue(messageBody, JsonObjejt.class);

  }

    @Getter @Setter
    static class JsonObject{
        private String username;
        private int age;
    }

}

- JsonObject 클래스는 Java 객체로, Json 요청이 왔을 때 파싱하는 용도로 사용된다. 
- 스프링에서 Json을 사용할 땐 Jackson 라이브러리를 많이 사용한다. (스프링에서 기본으로 제공)


<HTTP SERVLET RESPONSE>

<HTTP 응답 데이터>
- Http 요청을 서버에서 처리한 뒤 클라이언트로 결과를 전달할 때 개발자는 Response 메시지를 직접 만들지 않아도 된다. 
- WAS가 Response 객체를 지원하고 Servlet이 해당 객체를 사용하여 편의 기능을 제공

@WebServlet(name = "test", urlPatterns = "/request-body-json)
public class JsonEx extends HttpServlet{

  private ObjectMapper objectMapper = new ObjectMapper();

    @Override
    protected void service(HttpServletRequest request, HttpServletResponse response) 
                                                      throws ServletException, IOException{
        response.setHeader("Content-Type", "text/plain; charset=utf-8");
        response.setHeader("Cahe-Control", "no-cache, no-store, must-revalidate");
        response.setHeader("Pragma", "no-cache");
        response.setHeader("my-header", "hello");
    
        response.setContentType("text/plain"); //단순 응답은 plain (content-type)
        response.setContentType("text/html");  //HTML을 반환할 때는 html (content-type)
        response.setCharacterEncoding("utf-8")'
        //response.setContentLenght(2) : 생략 시 자동 생성
    
        Cookie cookie = new Cookie("cookie1", "value1"); //key - value로 저장되어있다.
        cookie.setMaxAge(600); //600초
        response.addCookie(cookie);
    
        response.sendRedirect("/main");

        //HTML로 응답 & 단순 텍스트 응답
        //단순 텍스트 응답 : writer.println("ok");  => response.setContentType("text/plain");
        //HTML 응답 : 직접 HTML을 작성해야 한다.
        response.setContentType("text/html"); 
        response.setCharacterEncoding("utf-8");
        PrinterWriter writer = response.getWriter();
        writer.println("<html>");
        writer.println("<body>");
        writer.println("  <div>hello</div");
        writer.println("</body>");
        writer.println("</html>");

        //Json으로 응답
        response.setHeader("content-type", "application/json");
        response.setCharacterEncoding("utf-8");

        JsonObject jsonObjcet = new JsonObject();
        jsonObject.setUsername("kim");
        jsonObjcet.setAge(20);
  
        String result = objectMapper.writeValueAsString(jsonObject);
        response.getWriter().write(result);
    }  


    @Getter @Setter
    static class JsonObject{
        private String username;
        private int age;
    }
}


